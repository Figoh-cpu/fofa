import os
import re
import requests
import time
import concurrent.futures
import subprocess
from datetime import datetime, timezone, timedelta

# ===============================
# é…ç½®åŒº
FOFA_URLS = {
    "https://fofa.info/result?qbase64=InVkcHh5IiAmJiBjb3VudHJ5PSJDTiI%3D": "ip.txt",
}
HEADERS = {
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64)"
}

COUNTER_FILE = "è®¡æ•°.txt"
IP_DIR = "ip"
RTP_DIR = "rtp"
ZUBO_FILE = "zubo.txt"
IPTV_FILE = "IPTV.txt"

# ===============================
# åˆ†ç±»ä¸æ˜ å°„é…ç½®
CHANNEL_CATEGORIES = {
"å¤®è§†é¢‘é“":[
"CCTV-1ç»¼åˆ","CCTV-2è´¢ç»","CCTV-3ç»¼è‰º","CCTV-4ä¸­æ–‡å›½é™…","CCTV-5ä½“è‚²","CCTV-5+ä½“è‚²èµ›äº‹","CCTV-6ç”µå½±","CCTV-7å›½é˜²å†›äº‹","CCTV-8ç”µè§†å‰§","CCTV-9çºªå½•","CCTV-10ç§‘æ•™","CCTV-11æˆæ›²","CCTV-12ç¤¾ä¼šä¸æ³•","CCTV-13æ–°é—»","CCTV-14å°‘å„¿","CCTV-15éŸ³ä¹","CCTV-16å¥¥æ—åŒ¹å…‹","CCTV-16å¥¥æ—åŒ¹å…‹4K","CCTV-17å†œä¸šå†œæ‘","CCTV-4æ¬§æ´²","CCTV-4ç¾æ´²","CCTV-4K","CCTV-8K","ä¸­å¤®æ–°å½±-ä¸­å­¦ç”Ÿ","ä¸­å¤®æ–°å½±-è€æ•…äº‹","ä¸­å¤®æ–°å½±-å‘ç°ä¹‹æ—…","CGTN","CGTN-çºªå½•","CGTN-æ³•è¯­","CGTN-ä¿„è¯­","CGTN-è¥¿ç­ç‰™è¯­","CGTN-é˜¿æ‹‰ä¼¯è¯­","ä¸­å›½æ•™è‚²1å°","ä¸­å›½æ•™è‚²2å°","ä¸­å›½æ•™è‚²4å°","æ—©æœŸæ•™è‚²"
],
"ä»˜è´¹é¢‘é“":[
"é£äº‘å‰§åœº","æ€€æ—§å‰§åœº","ç¬¬ä¸€å‰§åœº","é£äº‘è¶³çƒ","å¤®è§†å°çƒ","é«˜å°”å¤«Â·ç½‘çƒ","é£äº‘éŸ³ä¹","å¤®è§†æ–‡åŒ–ç²¾å“","å«ç”Ÿå¥åº·","ç”µè§†æŒ‡å—","å…µå™¨ç§‘æŠ€","å¥³æ€§æ—¶å°š","ä¸–ç•Œåœ°ç†","CHCå®¶åº­å½±é™¢","CHCåŠ¨ä½œç”µå½±","CHCå½±è¿·ç”µå½±"
],
"å«è§†é¢‘é“":[
"å±±ä¸œå«è§†", "æ¹–å—å«è§†", "æµ™æ±Ÿå«è§†", "æ±Ÿè‹å«è§†", "ä¸œæ–¹å«è§†", "æ·±åœ³å«è§†", "åŒ—äº¬å«è§†", "å¹¿ä¸œå«è§†", "å¹¿è¥¿å«è§†", "ä¸œå—å«è§†", "æµ·å—å«è§†","æ²³åŒ—å«è§†", "æ²³å—å«è§†", "æ¹–åŒ—å«è§†", "æ±Ÿè¥¿å«è§†", "å››å·å«è§†", "é‡åº†å«è§†", "è´µå·å«è§†", "äº‘å—å«è§†", "å¤©æ´¥å«è§†", "å®‰å¾½å«è§†","è¾½å®å«è§†", "é»‘é¾™æ±Ÿå«è§†", "å‰æ—å«è§†", "å†…è’™å¤å«è§†", "å®å¤å«è§†", "å±±è¥¿å«è§†", "é™•è¥¿å«è§†", "ç”˜è‚ƒå«è§†", "é’æµ·å«è§†","æ–°ç–†å«è§†", "è¥¿è—å«è§†", "ä¸‰æ²™å«è§†", "å…µå›¢å«è§†", "å»¶è¾¹å«è§†", "å®‰å¤šå«è§†", "åº·å·´å«è§†", "å†œæ—å«è§†", "å±±ä¸œæ•™è‚²å«è§†","å¤§æ¹¾åŒºå«è§†","æµ·å³¡å«è§†","è¥¿è—å«è§†è—è¯­","å®‰å¤šå«è§†è—è¯­","åº·å·´å«è§†è—è¯­","å†…è’™å¤å«è§†è’™è¯­"
],
"é«˜æ¸…é¢‘é“":[
"åŒ—äº¬å«è§†4K","å¹¿ä¸œå«è§†4K","æ·±åœ³å«è§†4K","å±±ä¸œå«è§†4K","æ¹–å—å«è§†4K","æµ™æ±Ÿå«è§†4K","æ±Ÿè‹å«è§†4K","ä¸œæ–¹å«è§†4K","å››å·å«è§†4K"
],
"å›½é™…é¢‘é“":[
"å‡¤å‡°å«è§†","å‡¤å‡°èµ„è®¯","å‡¤å‡°é¦™æ¸¯","å‡¤å‡°ç”µå½±","æ˜Ÿç©ºå«è§†","Channel[V]"
],
"æ•°å­—é¢‘é“":[
"é‡‘é¹°å¡é€š","å¿«ä¹å‚é’“","èŒ¶é¢‘é“","æ±‚ç´¢çºªå½•","ä¸­å›½å¤©æ°”","å¤©å…ƒå›´æ£‹","ç›å½©ç«æŠ€","ç›å½©ç¯®çƒ","ç›å½©é’å°‘å¹´","ç›å½©å¹¿åœºèˆ","åŒ—äº¬çºªå®ç§‘æ•™","é‡æ¸©ç»å…¸ç”µå½±","å°‘å„¿åŠ¨ç”»","å¡é…·å°‘å„¿","åŠ¨æ¼«ç§€åœº","å˜‰ä½³å¡é€š","ä¼˜æ¼«å¡é€š","å“ˆå“ˆç‚«åŠ¨","æ–°åŠ¨æ¼«","ä¼˜ä¼˜å®è´","é‡‘è‰²å­¦å ‚","ä¹æ¸¸","æ¸¸æˆé£äº‘","éƒ½å¸‚å‰§åœº","æ³•æ²»å¤©åœ°","æ¢¨å›­é¢‘é“","æ­¦æœ¯ä¸–ç•Œ","æ–‡ç‰©å®åº“","ç²¾å½©å½±è§†","ç”Ÿæ´»æ—¶å°š","ä¸­å›½äº¤é€š","æ±½æ‘©é¢‘é“","é­…åŠ›è¶³çƒ","å…ˆé”‹ä¹’ç¾½","å››æµ·é’“é±¼","ä¸­åç‰¹äº§","ç¯çƒæ—…æ¸¸","ä¸œæ–¹è´¢ç»","ä¹¦ç”»é¢‘é“","ç”Ÿæ€ç¯å¢ƒ","å®¶åº­ç†è´¢","è´¢å¯Œå¤©ä¸‹","è½¦è¿·é¢‘é“","æµ·æ´‹é¢‘é“","å†›äº‹","è§£å¯†","åœ°ç†","å¯¼è§†","è¶³çƒ","æˆæ›²","æ¥é’“é±¼å§","éº»è¾£ä½“è‚²","ç»šå½±4K","ä¹é¾„å­¦å ‚","4Kä¹äº«è¶…æ¸…","ç²¾å½©æ¨è"
],
"å±±ä¸œé¢‘é“":[
"å±±ä¸œé½é²","å±±ä¸œä½“è‚²","å±±ä¸œå†œç§‘","å±±ä¸œæ–°é—»","å±±ä¸œå°‘å„¿","å±±ä¸œæ–‡æ—…","å±±ä¸œç»¼è‰º","å±±ä¸œç”Ÿæ´»","å±±ä¸œæ•™è‚²å«è§†","å±±ä¸œå±…å®¶è´­ç‰©","QTV-1","QTV-2","QTV-3","QTV-4","QTV-5","å´‚å±±ç»¼åˆ","é»„å²›ç»¼åˆ","é»„å²›ç”Ÿæ´»","èƒ¶å·ç»¼åˆ","å¹³åº¦æ–°é—»","è±è¥¿ç»¼åˆ","æµå—æ–°é—»","æµå—æ–°é—»","æµå—æ•™è‚²","æµå—éƒ½å¸‚","æµå—ç”Ÿæ´»","æµå—æ–‡æ—…æ•™è‚²","æµå—å¨±ä¹","æµå—å°‘å„¿","æµå—é²ä¸­","å†åŸç»¼åˆ","é•¿æ¸…æ–°é—»","æµé˜³ç»¼åˆ","å¹³é˜´ç»¼åˆ","å•†æ²³ç»¼åˆ","æ·„åšæ–°é—»","æ·„åšå½±è§†","æ·„åšæ–‡æ—…","æ·„åšæ°‘ç”Ÿ","å¼ åº—ç»¼åˆ","æ·„å·æ–°é—»","å‘¨æ‘æ–°é—»","æ¡“å°ç»¼åˆ","é«˜é’ç»¼åˆ","æ²‚æºæ–°é—»","ä¸œè¥ç»¼åˆ","ä¸œè¥å…¬å…±","å¹¿é¥¶æ–°é—»","çƒŸå°æ–°é—»","çƒŸå°å…¬å…±","çƒŸå°ç»æµç§‘æ•™","çƒŸå°å½±è§†","ç‰Ÿå¹³æ–°é—»","ç‰Ÿå¹³ç”Ÿæ´»","è“¬è±æ–°é—»","é¾™å£ç»¼åˆ","æ‹›è¿œç»¼åˆ","æ –éœç»¼åˆ","æµ·é˜³ç»¼åˆ","æµ·é˜³ç»¼è‰º","é•¿å²›ç»¼åˆ","æ½åŠæ–°é—»","æ½åŠç»æµç”Ÿæ´»","æ½åŠå½±è§†ç»¼è‰º","æ½åŠç§‘æ•™æ–‡æ—…","æ½åŠé«˜æ–°åŒº","é’å·æ–°é—»","é’å·æ–‡æ—…","è¯¸åŸæ–°é—»","å¯¿å…‰æ–°é—»","å¯¿å…‰è”¬èœ","å®‰ä¸˜æ–°é—»","é«˜å¯†ç»¼åˆ","æ˜Œé‚‘ç»¼åˆ","æ˜Œä¹ç»¼åˆ","ä¸´æœç»¼åˆ","æµå®ç»¼åˆ","æµå®ç”Ÿæ´»","æµå®å…¬å…±","æµå®é«˜æ–°","ä»»åŸ-1","ä»»åŸ-2","å…–å·æ–°é—»","æ›²é˜œæ–°é—»ç»¼åˆ","é‚¹åŸç»¼åˆ","é±¼å°æ–°é—»","é±¼å°ç”Ÿæ´»","å˜‰ç¥¥ç»¼åˆ","æ¢å±±ç»¼åˆ","æ³°å±±ç”µè§†","è‚¥åŸç»¼åˆ","å²±å²³æœ‰çº¿","æ–°æ³°ç»¼åˆ","æ–°æ³°ä¹¡æ‘","å®é˜³ç»¼åˆ","å®é˜³å½±è§†","ä¸œå¹³æ–°é—»","å¨æµ·æ–°é—»","å¨æµ·éƒ½å¸‚ç”Ÿæ´»","æ–‡ç™»ç»¼åˆ","è£æˆç»¼åˆ","ä¹³å±±ç»¼åˆ","æ—¥ç…§æ–°é—»","æ—¥ç…§ç§‘æ•™","æ—¥ç…§å…¬å…±","è’å¿ç»¼åˆ","å²šå±±ç»¼åˆ","æ²³ä¸œç»¼åˆ","æ²‚æ°´ç»¼åˆ","æ²‚æ°´ç”Ÿæ´»","å…°é™µç»¼åˆ","å…°é™µå…¬å…±","äº”è²æ–°é—»","è’™é˜´ç»¼åˆ","ä¸´æ²­ç»¼åˆ","è’å—ç»¼åˆ","å¾·å·æ–°é—»ç»¼åˆ","å¾·å·ç»æµç”Ÿæ´»","é™µåŸæ–°é—»","ç¦¹åŸç»¼åˆ","ç¦¹åŸç»¼è‰º","å®æ´¥ç»¼åˆ","é½æ²³ç»¼åˆ","æ­¦åŸæ–°é—»","æ­¦åŸç»¼è‰ºå½±è§†","å¹³åŸæ–°é—»","å¤æ´¥æ–°é—»","å¤æ´¥å…¬å…±","ä¸´é‚‘ç»¼åˆ","èŠåŸç»¼åˆ","èŠåŸæ°‘ç”Ÿ","èŒŒå¹³æ–°é—»","ä¸´æ¸…ç»¼åˆ","è˜å¿ç»¼åˆ","å† å¿ç»¼åˆ","ä¸œé˜¿ç»¼åˆ","æ»¨å·ç»¼åˆ","æ»¨å·æ°‘ç”Ÿ","æ²¾åŒ–ç»¼åˆ","é‚¹å¹³æ–°é—»","æƒ æ°‘ç»¼åˆ","é˜³ä¿¡æ–°é—»","æ— æ££æ–°é—»","èæ³½æ–°é—»","èæ³½ç”Ÿæ´»","å®šé™¶TV-1","å•å¿ç»¼åˆ","é„„åŸæ–°é—»","éƒ“åŸç»¼åˆ","å·¨é‡æ–°é—»","ä¸œæ˜æ–°é—»","æ±¶ä¸Šç»¼åˆ","å±±ä¸œç»æµå¹¿æ’­","å±±ä¸œäº¤é€šå¹¿æ’­"
],
"å¹¿ä¸œé¢‘é“":[
"å¹¿ä¸œä½“è‚²","å¹¿ä¸œç æ±Ÿ","å¹¿ä¸œå½±è§†","å¹¿ä¸œæ°‘ç”Ÿ","å¹¿ä¸œç°ä»£æ•™è‚²","å¹¿ä¸œç»æµç§‘æ•™","å¹¿ä¸œæ–°é—»","å²­å—æˆæ›²","å¹¿ä¸œå˜‰ä½³å¡é€š","å¹¿ä¸œå°‘å„¿","å¹¿ä¸œç»¼è‰º4K","å¹¿å·ç»¼åˆ","å¹¿å·æ–°é—»","å¹¿å·å½±è§†","å¹¿å·æ³•æ²»","å—å›½éƒ½å¸‚4K","æ·±åœ³éƒ½å¸‚","æ·±åœ³ç”µè§†å‰§","æ·±åœ³é¾™å²—","æ·±åœ³è´¢ç»ç”Ÿæ´»","æ·±åœ³ä½“è‚²å¥åº·","æ·±åœ³å°‘å„¿","æ·±åœ³ä¼—åˆ›TV","å®å®‰é¢‘é“","ä½›å±±ç»¼åˆ","ä½›å±±å½±è§†","ä½›å±±å…¬å…±","ä¸œèç»¼åˆ","ä¸œèèµ„è®¯","ä½›å±±é¡ºå¾·","ä½›å±±å—æµ·","ç æµ·ç»¼åˆ","æ±•å°¾ç»¼åˆ","æ±•å°¾æ–‡åŒ–ç”Ÿæ´»","éŸ¶å…³ç»¼åˆ","æ¹›æ±Ÿç»¼åˆ","æ¹›æ±Ÿå…¬å…±","æ±Ÿé—¨ç»¼åˆ","æ±Ÿé—¨ä¾¨ä¹¡ç”Ÿæ´»","èŒ‚åç»¼åˆ","èŒ‚åæ–‡åŒ–ç”Ÿæ´»","æ­é˜³ç»¼åˆ","æ­é˜³ç”Ÿæ´»","äº‘æµ®ç»¼åˆ","äº‘æµ®æ–‡æ—…","æ±•å¤´ç»¼åˆ","æ±•å¤´ç»æµç”Ÿæ´»","æ±•å¤´ç»æµ","æ±•å¤´æ–‡æ—…ä½“è‚²","æ±•å¤´ä½“è‚²","æƒ å·-1","æƒ å·-2","æ½®å·ç»¼åˆ","æ½®å·æ°‘ç”Ÿ","æ¢…å·ç»¼åˆ","æ¢…å·å®¢å®¶ç”Ÿæ´»","ä¸­å±±ç»¼åˆ","ä¸­å±±æ–‡åŒ–","é˜³æ±Ÿ-1","é˜³æ±Ÿ-2","è‚‡åº†ç»¼åˆ","è‚‡åº†ç”Ÿæ´»","æ¸…è¿œç»¼åˆ","æ¸…è¿œç”Ÿæ´»","æ²³æºç»¼åˆ","æ²³æºå…¬å…±"
],
"ä¸Šæµ·é¢‘é“":[
"ä¸Šæµ·æ–°é—»ç»¼åˆ","äº”æ˜Ÿä½“è‚²","ç¬¬ä¸€è´¢ç»","ä¸Šæµ·éƒ½å¸‚","ä¸œæ–¹å½±è§†","ä¸œæ–¹è´¢ç»","ä¸Šæµ·æ•™è‚²","æ¬¢ç¬‘å‰§åœº4K","ä¸œæ–¹è´­ç‰©1","ä¸œæ–¹è´­ç‰©2","ä¸Šæµ·å¥åº·å…»ç”Ÿ","BesTV4KåŠ¨ç”»","BesTV4Kç”µå½±","BesTV4Kçºªå½•","BesTV4KåŠ¨ç”»","BesTVç”µå½±ä»‹ç»","BesTVäººæ–‡","BesTV4Kç”µå½±","BesTVç›´æ’­1","BesTVç›´æ’­2","BesTVç›´æ’­3","BesTV4Kç”µå½±","BesTVç›´æ’­4","BesTVç›´æ’­5","BesTVç›´æ’­6","BesTVç›´æ’­7","BesTVç›´æ’­8","BesTVç›´æ’­9","BesTVç”µå½±ä»‹ç»","BesTVç”µå½±ä»‹ç»","BesTVç›´æ’­4","BesTVç›´æ’­10","BesTV4Kç”µå½±","BesTV4Kçºªå½•","BesTV4KåŠ¨ç”»"
],
"æ²³åŒ—é¢‘é“":[
"æ²³åŒ—ç»æµç”Ÿæ´»","æ²³åŒ—éƒ½å¸‚","æ²³åŒ—å½±è§†å‰§","æ²³åŒ—å°‘å„¿ç§‘æ•™","æ²³åŒ—æ–‡æ—…å…¬å…±","æ²³åŒ—å†œæ°‘","ç›å½©æ²³åŒ—","æ²³åŒ—æ‚æŠ€","æ²³åŒ—ä¸‰ä½³è´­ç‰©","çŸ³å®¶åº„æ–°é—»ç»¼åˆ","çŸ³å®¶åº„æ–‡åŒ–å¨±ä¹","çŸ³å®¶åº„åŸå¸‚æœåŠ¡","æ‰¿å¾·æ–°é—»ç»¼åˆ","æ‰¿å¾·æ—…æ¸¸æ–‡åŒ–","ç§¦çš‡å²›æ–°é—»ç»¼åˆ","ç§¦çš‡å²›å…¬å…±","ç§¦çš‡å²›å½±è§†","å”å±±æ–°é—»ç»¼åˆ","å”å±±ç”Ÿæ´»æœåŠ¡","å”å±±å½±è§†","å”å±±å…¬å…±","å»ŠåŠæ–°é—»ç»¼åˆ","å»ŠåŠç”Ÿæ´»","ä¿å®šæ–°é—»ç»¼åˆ","ä¿å®šå…¬å…±","ä¿å®šç”Ÿæ´»å¥åº·","è¡¡æ°´æ–°é—»ç»¼åˆ","è¡¡æ°´ç»æµç§‘æ•™","é‚¢å°ç»¼åˆ","é‚¢å°åŸå¸‚ç”Ÿæ´»","é‚¯éƒ¸æ–°é—»ç»¼åˆ","é‚¯éƒ¸å…¬å…±","é‚¯éƒ¸ç§‘æŠ€æ•™è‚²","é«˜é‚‘èåª’","äº•é™‰çŸ¿åŒºç”µè§†å°","æ·±æ³½ç»¼åˆ","èµµå¿ç»¼åˆ","æ™‹å·ç»¼åˆ","äº•é™‰ç»¼åˆ","å¹³æ³‰ç»¼åˆ","å…´éš†ç»¼åˆ","éš†åŒ–ç»¼åˆ","å´‡ç¤¼ç”µè§†å°","åº·ä¿ç»¼åˆ","éµåŒ–ç»¼åˆ","ä¸‰æ²³ç»¼åˆ","æ°¸æ¸…ç»¼åˆ","æˆå®‰ç»¼åˆ","é­å¿ç»¼åˆæ–°é—»","æ»¦å—ç»¼åˆ","ç‰ç”°ç»¼åˆ","å´æ¡¥ç»¼åˆ","é˜œå¹³ç”µè§†å°","æ¶æ°´ç»¼åˆ","é»„éª…ç”µè§†å°","å®šå·æ–°é—»ç»¼åˆ","é›„å¿ç”µè§†å°","æ¶æºç»¼åˆ","é«˜ç¢‘åº—ç»¼åˆ","æ¶¿å·ç»¼åˆ","å”å¿ç»¼åˆ","æ›²é˜³ç»¼åˆ","æŸä¹¡ç»¼åˆ","å¾æ°´ç”µè§†å°","æ™¯å¿ç»¼åˆ","é¥¶é˜³ç”µè§†å°","æ·±å·æ–°é—»ç»¼åˆ","æ¶‰å¿ç»¼åˆ","é¸¡æ³½æ–°é—»ç»¼åˆ","æ­¦å®‰æ–°é—»ç»¼åˆ","æ£å¼ºç»¼åˆ","æ¸…æ²³ç”µè§†å°","å¤§å‚èåª’ä½“ä¸­å¿ƒ","é¡ºå¹³ç”µè§†","èµ¤åŸç”µè§†","é‚¯å±±ç”µè§†","ä»»å¿ç”µè§†","åŒæ»¦ç”µè§†","æ»¦å¹³ç”µè§†","èµçš‡ç”µè§†","æ ¾åŸç”µè§†","å¼ å®¶å£æ–°é—»ç»¼åˆ","å¼ å®¶å£å…¬å…±","æ²§å·æ–°é—»ç»¼åˆ","æ²§å·å…¬å…±","æ²§å·å½±è§†å¨±ä¹","æ˜Œé»ç”µè§†","æŠšå®ç”µè§†","å¢é¾™ç”µè§†","ä¸°å—ç”µè§†","è¿è¥¿ç”µè§†","æ»¦å·ç”µè§†","é¦™æ²³ç”µè§†","å¤§åŸç”µè§†","å›ºå®‰ç”µè§†","éœ¸å·ç”µè§†","å­Ÿæ‘ç”µè§†","ä¸œå…‰ç”µè§†","é’å¿ç”µè§†","ç›å±±ç”µè§†","å—çš®ç”µè§†","è‚ƒå®ç”µè§†","ä¸°å®ç”µè§†","å®šå…´ç”µè§†","æ»¡åŸç”µè§†","æœ›éƒ½ç”µè§†","é«˜é˜³ç”µè§†","å®‰æ–°ç”µè§†","å®¹åŸç”µè§†","æ¶¿é¹¿ç”µè§†","å¤§åç”µè§†","å†€å·ç”µè§†","å®‰å¹³ç”µè§†","é˜œåŸç”µè§†","æ•…åŸç”µè§†","å¹¿å®—ç”µè§†","å®æ™‹ç”µè§†","å¹³ä¹¡ç”µè§†","éš†å°§ç”µè§†","å¹¿å¹³ç”µè§†","å—å’Œç”µè§†","ä¸´æ¼³ç”µè§†å°","å†…ä¸˜ç”µè§†å°","è¿å®‰ç”µè§†","é¦†é™¶ç”µè§†","ä¹äº­ç”µè§†","æ²™æ²³ç”µè§†","å—å®«ç”µè§†","ä¸°æ¶¦ç”µè§†","æ²³åŒ—ä¸´æ—¶ç›´æ’­é¢‘é“ 2","æ²³åŒ—ä¸´æ—¶ç›´æ’­é¢‘é“ 3","æ²³åŒ—ç¾½æ¯›çƒä¸“åŒº","æ²³åŒ—ä¸­å¼å…«çƒå›½é™…å…¬å¼€èµ›","æ²³åŒ—ä¹å±ç›´æ’­"
],
"å››å·é¢‘é“":[
"å››å·æ–‡åŒ–æ—…æ¸¸","å››å·ç»æµ","å››å·æ–°é—»","å››å·å½±è§†æ–‡è‰º","å››å·å³¨çœ‰ç”µå½±","å››å·æ˜Ÿç©ºè´­ç‰©","å››å·å¦‡å¥³å„¿ç«¥","å››å·ç§‘æ•™","å››å·ä¹¡æ‘","ç†ŠçŒ«æ–°é—»","ç†ŠçŒ«ä½“å¨±","ç†ŠçŒ«å°‘å„¿","ç†ŠçŒ«å½±é™¢","äº‘çœ‹ç†ŠçŒ«","é‡‘ç†ŠçŒ«å¡é€š","è“‰åŸå…ˆé”‹","æˆéƒ½æ–°é—»ç»¼åˆ","æˆéƒ½ç»æµèµ„è®¯æœåŠ¡","æˆéƒ½éƒ½å¸‚ç§‘æ•™","æˆéƒ½å½±è§†æ–‡è‰º","æˆéƒ½å…¬å…±","æˆéƒ½å°‘å„¿","æˆéƒ½æ¯æ—¥è´­ç‰©","ç†ŠçŒ«çˆ±ç”Ÿæ´»","iæˆéƒ½","å¤§çˆ±å››å·","å¤§çˆ±æ—…æ¸¸","å¤§çˆ±ç”Ÿæ´»","å¤§çˆ±æ—¶å°š","çº¢åŸæ—¥å¹²ä¹”","çº¢åŸæœˆäº®æ¹¾","å››å·ç”µä¿¡å¯¼è§†3","é›…å…‹éŸ³ä¹èŠ‚ç›´æ’­","é›…å…‹éŸ³ä¹èŠ‚å®£ä¼ ","äº‘æ¼”è‰ºå®£ä¼ ","åè¥¿è¯åˆ¸","å››å·çˆ±ä¸Š4K","å››å·4Kè§†ç•Œ","å››å·ç²¾å½©å¯¼è§†","å››å·å®¶æ”¿é¢‘é“","å››å·ç»å…¸ç”µå½±","å››å·åè¯­å½±é™¢","å››å·æ˜Ÿå…‰é™¢çº¿","å››å·å…¨çƒå¤§ç‰‡","å››å·çƒ­æ’­å‰§åœº","å››å·çƒ­é—¨å‰§åœº","å››å·å¥åº·å…»ç”Ÿ","å››å·è°æˆ˜å‰§åœº","å››å·å®å®åŠ¨ç”»","å››å·é’æ˜¥åŠ¨æ¼«","å››å·çƒ­é—¨ç»¼è‰º","å››å·éŸ³ä¹ç°åœº","å››å·æˆæ›²ç²¾é€‰","å››å·é­…åŠ›æ—¶å°š","å››å·ç™¾å˜è¯¾å ‚","å››å·ç”µç«å¤©å ‚","å››å·çº¢è‰²å½±é™¢","å››å·ç»å…¸å‰§åœº","å››å·çˆ±ä½“è‚²","å››å·çˆ±ç”Ÿæ´»","å››å·çˆ±æµªæ¼«","å››å·çˆ±å–œå‰§","å››å·çˆ±å¥‡è°ˆ","å››å·çˆ±ç§‘å¹»","å››å·çˆ±é™¢çº¿","å››å·çˆ±è°æˆ˜","å››å·çˆ±å†å²","å››å·çˆ±æ‚¬ç–‘","å››å·çˆ±æ—…è¡Œ","å››å·çˆ±å¹¼æ•™","å››å·çˆ±ç©å…·","å››å·çˆ±åŠ¨æ¼«","å››å·çˆ±èµ›è½¦","å››å·çˆ±å® ç‰©","å››å·å°‘å„¿å¤©åœ°","å››å·æ”¶è§†æŒ‡å—","å››å·ä¸­å›½ä½“è‚²1","å››å·ä¸­å›½ä½“è‚²2","å››å·ä¸­å›½ä½“è‚²3","å››å·ç›´æ’­å®¤1","å››å·ç›´æ’­å®¤2","å››å·ç›´æ’­å®¤3","å››å·ç›´æ’­å®¤4","å››å·ç›´æ’­å®¤5","å››å·ç›´æ’­å®¤6","å››å·ç›´æ’­å®¤7","å››å·ç›´æ’­å®¤8"
]
#ä»»æ„æ·»åŠ ï¼Œä¸ä»“åº“ä¸­rtp/çœä»½è¿è¥å•†.txtå†…é¢‘é“ä¸€è‡´å³å¯ï¼Œæˆ–åœ¨ä¸‹æ–¹é¢‘é“åæ˜ å°„ä¸­æ”¹å
}
# ===== æ˜ å°„ï¼ˆåˆ«å -> æ ‡å‡†åï¼‰ =====
CHANNEL_MAPPING = {

}#æ ¼å¼ä¸º"é¢‘é“åˆ†ç±»ä¸­çš„æ ‡å‡†å": ["rtp/ä¸­çš„åå­—"],

# ===============================
# è®¡æ•°é€»è¾‘
def get_run_count():
    if os.path.exists(COUNTER_FILE):
        try:
            return int(open(COUNTER_FILE).read().strip())
        except:
            return 0
    return 0

def save_run_count(count):
    open(COUNTER_FILE, "w").write(str(count))

def check_and_clear_files_by_run_count():
    os.makedirs(IP_DIR, exist_ok=True)
    count = get_run_count() + 1
    if count >= 73:
        print(f"ğŸ§¹ ç¬¬ {count} æ¬¡è¿è¡Œï¼Œæ¸…ç©º {IP_DIR} ä¸‹æ‰€æœ‰ .txt æ–‡ä»¶")
        for f in os.listdir(IP_DIR):
            if f.endswith(".txt"):
                os.remove(os.path.join(IP_DIR, f))
        save_run_count(1)
        return "w", 1
    else:
        save_run_count(count)
        return "a", count

# ===============================
# IP è¿è¥å•†åˆ¤æ–­
def get_isp(ip):
    if re.match(r"^(1[0-9]{2}|2[0-3]{2}|42|43|58|59|60|61|110|111|112|113|114|115|116|117|118|119|120|121|122|123|124|125|126|127|175|180|182|183|184|185|186|187|188|189|223)\.", ip):
        return "ç”µä¿¡"
    elif re.match(r"^(42|43|58|59|60|61|110|111|112|113|114|115|116|117|118|119|120|121|122|123|124|125|126|127|175|180|182|183|184|185|186|187|188|189|223)\.", ip):
        return "è”é€š"
    elif re.match(r"^(223|36|37|38|39|100|101|102|103|104|105|106|107|108|109|134|135|136|137|138|139|150|151|152|157|158|159|170|178|182|183|184|187|188|189)\.", ip):
        return "ç§»åŠ¨"
    else:
        return "æœªçŸ¥"

# ===============================
# ç¬¬ä¸€é˜¶æ®µ - ä¿®æ”¹æ–‡ä»¶åç”Ÿæˆé€»è¾‘
def first_stage():
    all_ips = set()
    for url, filename in FOFA_URLS.items():
        print(f"ğŸ“¡ æ­£åœ¨çˆ¬å– {filename} ...")
        try:
            r = requests.get(url, headers=HEADERS, timeout=15)
            urls_all = re.findall(r'<a href="http://(.*?)"', r.text)
            all_ips.update(u.strip() for u in urls_all)
        except Exception as e:
            print(f"âŒ çˆ¬å–å¤±è´¥ï¼š{e}")
        time.sleep(3)

    province_isp_dict = {}
    for ip_port in all_ips:
        try:
            ip = ip_port.split(":")[0]
            res = requests.get(f"http://ip-api.com/json/{ip}?lang=zh-CN", timeout=10)
            data = res.json()
            province = data.get("regionName", "æœªçŸ¥")
            isp = get_isp(ip)
            if isp == "æœªçŸ¥":
                continue
            
            # å»é™¤"çœ"å’Œ"å¸‚"å­—æ ·
            province_clean = province.replace("çœ", "").replace("å¸‚", "")
            fname = f"{province_clean}{isp}.txt"
            province_isp_dict.setdefault(fname, set()).add(ip_port)
        except Exception:
            continue

    mode, run_count = check_and_clear_files_by_run_count()
    for filename, ip_set in province_isp_dict.items():
        path = os.path.join(IP_DIR, filename)
        with open(path, mode, encoding="utf-8") as f:
            for ip_port in sorted(ip_set):
                f.write(ip_port + "\n")
        print(f"{path} å·²{'è¦†ç›–' if mode=='w' else 'è¿½åŠ '}å†™å…¥ {len(ip_set)} ä¸ª IP")
    print(f"âœ… ç¬¬ä¸€é˜¶æ®µå®Œæˆï¼Œå½“å‰è½®æ¬¡ï¼š{run_count}")
    return run_count

# ===============================
# ç¬¬äºŒé˜¶æ®µ - ä¿®æ”¹ä¸ºåªç”Ÿæˆrtpæ ¼å¼
def second_stage():
    print("ğŸ”” ç¬¬äºŒé˜¶æ®µè§¦å‘ï¼šç”Ÿæˆ zubo.txtï¼ˆä»…ç”Ÿæˆrtpæ ¼å¼ï¼‰")
    combined_lines = []
    for ip_file in os.listdir(IP_DIR):
        if not ip_file.endswith(".txt"):
            continue
        ip_path = os.path.join(IP_DIR, ip_file)
        rtp_path = os.path.join(RTP_DIR, ip_file)
        if not os.path.exists(rtp_path):
            continue

        with open(ip_path, encoding="utf-8") as f1, open(rtp_path, encoding="utf-8") as f2:
            ip_lines = [x.strip() for x in f1 if x.strip()]
            rtp_lines = [x.strip() for x in f2 if x.strip()]

        if not ip_lines or not rtp_lines:
            continue

        for ip_port in ip_lines:
            for rtp_line in rtp_lines:
                if "," not in rtp_line:
                    continue
                ch_name, rtp_url = rtp_line.split(",", 1)
                
                # æå–ç»„æ’­åœ°å€
                multicast_match = re.search(r'rtp://(.+)', rtp_url)
                if multicast_match:
                    multicast_addr = multicast_match.group(1)
                    
                    # åªç”Ÿæˆrtpæ ¼å¼åœ°å€
                    rtp_format_url = f"http://{ip_port}/rtp/{multicast_addr}"
                    combined_lines.append(f"{ch_name},{rtp_format_url}")

    # å»é‡
    unique = {}
    for line in combined_lines:
        url_part = line.split(",", 1)[1]
        if url_part not in unique:
            unique[url_part] = line

    with open(ZUBO_FILE, "w", encoding="utf-8") as f:
        for line in unique.values():
            f.write(line + "\n")
    print(f"ğŸ¯ ç¬¬äºŒé˜¶æ®µå®Œæˆï¼Œå…± {len(unique)} æ¡æœ‰æ•ˆ URLï¼ˆä»…rtpæ ¼å¼ï¼‰")

# ===============================
# ç¬¬ä¸‰é˜¶æ®µ - ä¿®æ”¹ä¸ºå…ˆæ£€æµ‹rtpï¼Œå¤±è´¥åˆ™å°è¯•udp
def third_stage():
    print("ğŸ§© ç¬¬ä¸‰é˜¶æ®µï¼šå¤šçº¿ç¨‹æ£€æµ‹é¢‘é“ç”Ÿæˆ IPTV.txtï¼ˆä¼˜å…ˆrtpï¼Œå¤±è´¥åˆ™å°è¯•udpï¼‰")

    if not os.path.exists(ZUBO_FILE):
        print("âš ï¸ zubo.txt ä¸å­˜åœ¨ï¼Œè·³è¿‡")
        return

    def check_stream(url, timeout=5):
        try:
            result = subprocess.run(
                ["ffprobe", "-v", "error", "-show_streams", "-i", url],
                stdout=subprocess.PIPE,
                stderr=subprocess.PIPE,
                timeout=timeout + 2
            )
            return b"codec_type" in result.stdout
        except Exception:
            return False

    alias_map = {}
    for main_name, aliases in CHANNEL_MAPPING.items():
        for alias in aliases:
            alias_map[alias] = main_name

    ip_info = {}
    for fname in os.listdir(IP_DIR):
        if not fname.endswith(".txt"):
            continue
        # æ³¨æ„ï¼šè¿™é‡Œä¿ç•™åŸå§‹æ–‡ä»¶åï¼ˆå·²å»é™¤çœå¸‚å­—æ ·ï¼‰
        province_operator = fname.replace(".txt", "")
        path = os.path.join(IP_DIR, fname)
        with open(path, encoding="utf-8") as f:
            for line in f:
                ip_port = line.strip()
                ip_info[ip_port] = province_operator

    # è¯»å–zubo.txtä¸­çš„é¢‘é“ä¿¡æ¯ï¼ˆéƒ½æ˜¯rtpæ ¼å¼ï¼‰
    channels_by_ip = {}
    with open(ZUBO_FILE, encoding="utf-8") as f:
        for line in f:
            if "," not in line:
                continue
            ch_name, url = line.strip().split(",", 1)
            ch_main = alias_map.get(ch_name, ch_name)
            m = re.match(r"http://(\d+\.\d+\.\d+\.\d+:\d+)/", url)
            if m:
                ip_port = m.group(1)
                # æå–ç»„æ’­åœ°å€
                multicast_match = re.search(r'/rtp/(.+)', url)
                if multicast_match:
                    multicast_addr = multicast_match.group(1)
                    channels_by_ip.setdefault(ip_port, []).append((ch_main, multicast_addr))

    def detect_channel(ip_port, ch_main, multicast_addr):
        # å…ˆå°è¯•rtpæ ¼å¼
        rtp_url = f"http://{ip_port}/rtp/{multicast_addr}"
        if check_stream(rtp_url):
            return ip_port, ch_main, rtp_url, "rtp"
        
        # rtpæ ¼å¼å¤±è´¥ï¼Œå°è¯•udpæ ¼å¼
        udp_url = f"http://{ip_port}/udp/{multicast_addr}"
        if check_stream(udp_url):
            return ip_port, ch_main, udp_url, "udp"
        
        # ä¸¤ç§æ ¼å¼éƒ½å¤±è´¥
        return ip_port, ch_main, None, None

    print(f"ğŸš€ å¯åŠ¨å¤šçº¿ç¨‹æ£€æµ‹ï¼ˆå…± {len(channels_by_ip)} ä¸ª IPï¼‰...")
    
    valid_channels = []
    total_channels = sum(len(channels) for channels in channels_by_ip.values())
    processed = 0
    
    with concurrent.futures.ThreadPoolExecutor(max_workers=10) as executor:
        # ä¸ºæ¯ä¸ªé¢‘é“åˆ›å»ºæ£€æµ‹ä»»åŠ¡
        futures = []
        for ip_port, channels in channels_by_ip.items():
            for ch_main, multicast_addr in channels:
                futures.append(executor.submit(detect_channel, ip_port, ch_main, multicast_addr))
        
        # å¤„ç†æ£€æµ‹ç»“æœ
        for future in concurrent.futures.as_completed(futures):
            ip_port, ch_main, url, format_type = future.result()
            processed += 1
            
            if url:  # å¦‚æœæ£€æµ‹æˆåŠŸ
                province_operator = ip_info.get(ip_port, "æœªçŸ¥")
                valid_channels.append((ch_main, url, province_operator))
                
            # æ‰“å°è¿›åº¦
            if processed % 100 == 0 or processed == total_channels:
                print(f"ğŸ“Š æ£€æµ‹è¿›åº¦: {processed}/{total_channels}ï¼Œæœ‰æ•ˆé¢‘é“: {len(valid_channels)}")

    print(f"âœ… æ£€æµ‹å®Œæˆï¼Œæœ‰æ•ˆé¢‘é“: {len(valid_channels)} ä¸ª")
    
    # ç»Ÿè®¡æ ¼å¼ä½¿ç”¨æƒ…å†µ
    rtp_count = sum(1 for _, url, _ in valid_channels if "/rtp/" in url)
    udp_count = sum(1 for _, url, _ in valid_channels if "/udp/" in url)
    print(f"   - RTP æ ¼å¼: {rtp_count} ä¸ª")
    print(f"   - UDP æ ¼å¼: {udp_count} ä¸ª")

    # å»é‡
    seen = set()
    unique_channels = []
    for ch_main, url, province_operator in valid_channels:
        key = f"{ch_main},{url}"
        if key not in seen:
            seen.add(key)
            unique_channels.append(f"{ch_main},{url}${province_operator}")

    beijing_now = datetime.now(timezone(timedelta(hours=8))).strftime("%Y-%m-%d %H:%M:%S")
    disclaimer_url = "https://kakaxi-1.asia/LOGO/Disclaimer.mp4"

    with open(IPTV_FILE, "w", encoding="utf-8") as f:
        f.write(f"#æ›´æ–°æ—¶é—´: {beijing_now}ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰\n\n")
        f.write("#æ›´æ–°æ—¶é—´,#genre#\n")
        f.write(f"#{beijing_now},{disclaimer_url}\n\n")

        for category, ch_list in CHANNEL_CATEGORIES.items():
            f.write(f"{category},#genre#\n")
            for ch in ch_list:
                for line in unique_channels:
                    name = line.split(",", 1)[0]
                    if name == ch:
                        f.write(line + "\n")
            f.write("\n")

    print(f"ğŸ¯ IPTV.txt ç”Ÿæˆå®Œæˆï¼ˆå«æ›´æ–°æ—¶é—´ï¼‰ï¼Œå…± {len(unique_channels)} æ¡é¢‘é“")

# ===============================
# æ–‡ä»¶æ¨é€  
def push_all_files():
    print("ğŸš€ æ¨é€æ‰€æœ‰æ›´æ–°æ–‡ä»¶åˆ° GitHub...")
    os.system('git config --global user.name "github-actions"')
    os.system('git config --global user.email "github-actions@users.noreply.github.com"')
    os.system("git add è®¡æ•°.txt")
    os.system("git add ip/*.txt || true")
    os.system("git add IPTV.txt || true")
    os.system('git commit -m "è‡ªåŠ¨æ›´æ–°ï¼šè®¡æ•°ã€IPæ–‡ä»¶ã€IPTV.txt" || echo "âš ï¸ æ— éœ€æäº¤"')
    os.system("git push origin main || echo 'âš ï¸ æ¨é€å¤±è´¥'")


# ===============================
# ä¸»æ‰§è¡Œé€»è¾‘
if __name__ == "__main__":
    run_count = first_stage()
    if run_count in [12, 24, 36, 48, 60, 72]:
        second_stage()
        third_stage()
    push_all_files()
